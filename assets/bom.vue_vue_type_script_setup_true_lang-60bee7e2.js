import{U as de,P as le,_ as ne}from"./index-f25cfa19.js";import{d as pe,f as fe,a as ye}from"./formula-ff90f8d8.js";import{_ as ve,r,G as _,u as he,ao as te,c as B,d as w,g as U,e as o,f,i as H,w as u,m as j,h as k,Q as F,am as ge,R as Q,a4 as _e,M as be,W as oe,I as se,B as ie,p as De,j as Ce,ap as ke,aq as Ke,ar as Be}from"./index-eb14e6bd.js";import{L as re,T as Ie,I as ae,E as $e}from"./index-158b6f05.js";import{D as ue}from"./slotCell.vue_vue_type_script_lang-12effd0a.js";import{d as Re}from"./index-a6ad3bbb.js";import{I as P}from"./index-e40dd58c.js";const Te=c=>(De("data-v-09926627"),c=c(),Ce(),c),Ne={class:"box-pap"},Se={class:"photos"},xe={class:"params"},Fe=Te(()=>U("p",{class:"tips"},"tips：参数名只能由英文字母和数字组成，且必须由英文字母开头。",-1)),Ae={__name:"key",props:{isDetail:{type:Boolean,default:!1},isReal:{type:Boolean,default:!1}},emits:["change"],setup(c,{expose:z,emit:v}){const m=v,T=c,h=r([]),J="http://39.103.193.245:8080/common/upload",M=_(()=>({Authorization:`Bearer ${he().token}`})),L=l=>{h.value[0]={url:l.file.url}},N=()=>{h.value=[]},d=r([]),S=[{colKey:"serial-number",title:"#",width:60},{colKey:"key",title:"参数名",width:150},{colKey:"value",title:"参数值",width:150},{colKey:"desc",title:"描述"},{colKey:"operation",title:"操作",width:120}],b=_(()=>{const l=S.map(i=>i.colKey);return T.isDetail?l.filter(i=>i!="operation"):l}),O=l=>{d.value.splice(l,1)},K=r(!1),A=r(null),g=r(null),I=_(()=>`${g.value!==null?"编辑":"添加"}参数`),V=l=>new Promise(i=>{i(/^[a-zA-Z][a-zA-Z0-9]*$/.test(l))}),Z=r([{cmp:T.isReal?"desc":"input",name:"key",label:"参数名",rules:[{required:!0,message:"必填",type:"error",trigger:"blur"},{validator:V,message:"参数名格式不正确",trigger:"blur"}]},{cmp:"inputNumber",name:"value",label:"参数值",rules:[{required:!0,message:"必填",type:"error",trigger:"blur"}],itemOptions:{style:{width:"100%"}}},{cmp:T.isReal?"desc":"textarea",name:"desc",label:"描述"}]),q=(l=null)=>{g.value=l,K.value=!0,l!==null&&_e(()=>{A.value.fillFormData({...d.value[l]})})},$=l=>d.value.find((i,D)=>D!==g.value&&i.key===l),R=async()=>{const l=await A.value.getFormData(!0);if(l===!1)return!1;if($(l.key))return be.error({content:"参数名已存在"});g.value!==null?d.value[g.value]=l:d.value.push(l),K.value=!1};return te(d.value,l=>{m("change",l)}),z({getPhotos:()=>{var l;return(l=h.value[0])==null?void 0:l.url},getKeys:()=>d.value,setPhotos:l=>{l?h.value[0]={url:l}:h.value=[]},setKeys:(l,i)=>{const D=JSON.parse(l||"[]"),t=JSON.parse(i||"[]");t.length==D.length?d.value=D.map((e,n)=>({...e,...t[n]})):d.value=D,te(d.value,e=>{m("change",e)},{immediate:!0})}}),(l,i)=>{const D=de,t=re,e=le,n=oe,a=Ie,s=se,p=ie,y=ne,E=ue;return B(),w(Q,null,[U("div",Ne,[U("div",Se,[o(D,{class:"photos-upload",modelValue:f(h),"onUpdate:modelValue":i[0]||(i[0]=C=>H(h)?h.value=C:null),disabled:c.isDetail,theme:"image",locale:{triggerUploadText:{image:c.isDetail?"无示意图":"上传示意图"}},accept:"image/*",showImageFileName:!1,headers:f(M),action:J,onSuccess:L,onRemove:N},null,8,["modelValue","disabled","locale","headers"])]),U("div",xe,[o(a,ge({columns:S,data:f(d)},f(pe),{displayColumns:f(b)}),{operation:u(({rowIndex:C})=>[c.isDetail?F("",!0):(B(),j(n,{key:0},{default:u(()=>[o(t,{theme:"primary",onClick:G=>q(C)},{default:u(()=>[k(" 编辑")]),_:2},1032,["onClick"]),c.isReal?F("",!0):(B(),j(e,{key:0,content:"确认删除吗？",onConfirm:G=>O(C)},{default:u(()=>[o(t,{theme:"primary"},{default:u(()=>[k("删除")]),_:1})]),_:2},1032,["onConfirm"]))]),_:2},1024))]),_:1},16,["data","displayColumns"]),!c.isDetail&&!c.isReal?(B(),w(Q,{key:0},[Fe,o(p,{variant:"outline",theme:"default",onClick:i[1]||(i[1]=C=>q())},{icon:u(()=>[o(s,{name:"add"})]),default:u(()=>[k(" 添加参数 ")]),_:1})],64)):F("",!0)])]),o(E,{visible:f(K),"onUpdate:visible":i[2]||(i[2]=C=>H(K)?K.value=C:null),attach:"body",header:f(I),"destroy-on-close":"",placement:"center",width:"500px","on-confirm":R},{body:u(()=>[o(y,{ref_key:"$form",ref:A,forms:f(Z)},null,8,["forms"])]),_:1},8,["visible","header"])],64)}}},je=ve(Ae,[["__scopeId","data-v-09926627"]]),Ve={key:0},ze={__name:"bom",props:{isDetail:{type:Boolean,default:!1}},setup(c,{expose:z}){const v=c,m=r(null),T=r({}),h=r([]),J={childrenKey:"children",defaultExpandAll:!0},M=[{colKey:"id",title:"组件",width:100},{colKey:"model",title:"模块",cell:(t,{row:e})=>{var n;return e.material?((n=Re[e.material.itemCategory])==null?void 0:n.label)||"未知":"组件"},width:70},{colKey:"name",title:"组件名"},{colKey:"materialClass",title:"物料分类",cell:(t,{row:e})=>e.material?e.material.itemTypeName||"未知":"-"},{colKey:"material",title:"物料",cell:(t,{row:e})=>e.material?e.material.itemName||"未知":"-"},{colKey:"formula",title:"公式",cell:(t,{row:e})=>{var n,a,s,p;return v.isDetail?o("div",null,[e.material?o("div",null,[((n=e.material)==null?void 0:n.itemCategory)==3?"高：":"",e.formula]):"",((a=e.material)==null?void 0:a.itemCategory)==3?o("div",null,[k("宽："),e.formula2]):""]):o("div",null,[e.material?o(P,{label:((s=e.material)==null?void 0:s.itemCategory)==3?"高":"",modelValue:e.formula,"onUpdate:modelValue":y=>e.formula=y,onChange:N(e,1)},null):"",((p=e.material)==null?void 0:p.itemCategory)==3?o(P,{style:"margin-top:10px",label:"宽",modelValue:e.formula2,"onUpdate:modelValue":y=>e.formula2=y,onChange:N(e,2)},null):""])},width:250},{colKey:"result",title:"结果",cell:(t,{row:e})=>{var n,a,s;return o("div",null,[e.material?o("div",null,[(((n=e.material)==null?void 0:n.itemCategory)==3?"高：":"")+S(v.isDetail?N(e,1,!0):e.result)]):"",((a=e.material)==null?void 0:a.itemCategory)==3?o("div",{style:"margin-top:10px"},[k("宽："),S(v.isDetail?N(e,2,!0):e.result)]):"",((s=e.material)==null?void 0:s.itemCategory)==3?o("div",{style:"margin-top:10px"},[k("理论面积："),S(d(e))]):""])}},{colKey:"quantity",title:"数量（只针对上一级）",edit:v.isDetail?!1:{component:ae,keepEditMode:!0,props:{min:1},onEdited:t=>{t.row.quantity=t.newRowData.quantity}},width:180},{colKey:"unit",title:"单位",edit:v.isDetail?!1:{component:P,keepEditMode:!0,onEdited:t=>{t.row.unit=t.newRowData.unit}},width:80},{colKey:"extra",title:"附加值",cell:(t,{row:e})=>{var n,a;return v.isDetail?o("div",null,[((n=e.material)==null?void 0:n.itemCategory)==2?e.extra:""]):o("div",null,[((a=e.material)==null?void 0:a.itemCategory)==2?o(ae,{modelValue:e.extra,"onUpdate:modelValue":s=>e.extra=s},null):""])},width:180},{colKey:"desc",title:"描述",edit:v.isDetail?!1:{component:P,keepEditMode:!0,onEdited:t=>{t.row.desc=t.newRowData.desc}}},{colKey:"operation",title:"操作",width:140}],L=_(()=>{const t=M.map(e=>e.colKey);return v.isDetail?t.filter(e=>e!="operation"):t}),N=(t,e=1,n=!1)=>{const a=t[`formula${e>1?e:""}`],s=fe(a,T.value);if(t[`result${e>1?e:""}`]=s,n)return s},d=t=>ye(t.result,t.result2),S=t=>typeof t>"u"||t===""?"空":isNaN(t)?"无效结果":t,b=r(null),O=(t=null)=>{b.value=t,Y()},K=t=>{var e,n;b.value?m.value.appendTo(b.value.id,{...t,id:`${b.value.id}-${(((n=(e=b.value)==null?void 0:e.children)==null?void 0:n.length)||0)+1}`}):m.value.appendTo(void 0,{...t,id:`${m.value.getTreeNode().length+1}`})},A=t=>{var a,s;const e=t.id.split("-"),n=parseInt(e[e.length-1]);if(m.value.remove(t.id),e.length<2){const p=m.value.getTreeNode();g(p,n)}else{const p=e.slice(0,-1).join("-"),y=(s=(a=m.value.getData(p))==null?void 0:a.row)==null?void 0:s.children;g(y,n)}},g=(t=[],e,n=[])=>{if(n.length)for(let a=0;a<t.length;a++){const p=t[a].id.split("-").map((y,E)=>n[E]||y);m.value.setData(t[a].id,{...t[a],id:p.join("-")}),t[a].children&&t[a].children.length&&g(t[a].children,null,p)}else for(let a=e-1;a<t.length;a++){const s=t[a].id.split("-");s[s.length-1]=s[s.length-1]-1,m.value.setData(t[a].id,{...t[a],id:s.join("-")}),t[a].children&&t[a].children.length&&g(t[a].children,null,s)}},I=r(!1),V=r(null),Z=_(()=>"添加组件"),q=r([]),$=r(!0),R=r([]),W=r([{cmp:"input",name:"name",label:"组件名",rules:[{required:!0,message:"必填",type:"error",trigger:"blur"}]},{cmp:"treeSelect",name:"materialClass",label:"物料分类",rules:_(()=>b.value!==null?[{required:!0,message:"组件内必选物料分类",type:"error",trigger:"change"}]:null),itemOptions:{clearable:!0,data:_(()=>q.value),keys:{value:"id"},onChange:t=>{t?(ke({itemTypeId:t}).then(e=>{R.value=e.rows}),$.value=!1):(R.value=[],$.value=!0),V.value.setFormDataByName("material",null)}}},{cmp:"select",name:"material",label:"物料",rules:_(()=>b.value!==null||!$.value?[{required:!0,message:"组件内必选物料",type:"error",trigger:"change"}]:null),itemOptions:{keys:{value:"itemId",label:"itemName"},options:_(()=>R.value),disabled:_(()=>$.value)}}]),X=()=>{Be().then(t=>{q.value=t.data||[]})},Y=()=>{X(),R.value=[],$.value=!0,I.value=!0},ee=async()=>{const t=await V.value.getFormData(!0);if(t===!1)return!1;const e=Ke(R.value,t.material,"itemId");K(e?{...t,material:e,quantity:1,unit:e.unitOfMeasure||"个"}:{...t,quantity:1,unit:"个"}),I.value=!1};return z({changeKeyData:t=>{T.value=t.reduce((e,n)=>(e[n.key]=n.value,e),{})},getBomData:()=>m.value.getTreeNode()||[],setBomData:t=>{m.value.resetData(JSON.parse(t||"[]"))}}),(t,e)=>{const n=re,a=le,s=oe,p=$e,y=se,E=ie,C=ne,G=ue;return B(),w(Q,null,[o(p,{ref_key:"$table",ref:m,columns:M,data:f(h),bordered:"",tree:J,rowKey:"id",displayColumns:f(L)},{operation:u(({row:x,rowIndex:ce})=>[c.isDetail?F("",!0):(B(),j(s,{key:0},{default:u(()=>[o(a,{content:"删除后，下级也将被删除，确认删除吗？",onConfirm:me=>A(x)},{default:u(()=>[o(n,{theme:"primary"},{default:u(()=>[k("删除")]),_:1})]),_:2},1032,["onConfirm"]),x.material?F("",!0):(B(),j(n,{key:0,theme:"primary",onClick:me=>O(x,ce)},{default:u(()=>[k(" 添加下级")]),_:2},1032,["onClick"]))]),_:2},1024))]),_:1},8,["data","displayColumns"]),c.isDetail?F("",!0):(B(),w("p",Ve,[o(E,{variant:"outline",theme:"default",onClick:e[0]||(e[0]=x=>O())},{icon:u(()=>[o(y,{name:"add"})]),default:u(()=>[k(" 添加组件 ")]),_:1})])),o(G,{visible:f(I),"onUpdate:visible":e[1]||(e[1]=x=>H(I)?I.value=x:null),attach:"body",header:f(Z),"destroy-on-close":"",placement:"center",width:"500px","on-confirm":ee},{body:u(()=>[o(C,{ref_key:"$form",ref:V,forms:f(W)},null,8,["forms"])]),_:1},8,["visible","header"])],64)}}};export{je as C,ze as _};
