import{_ as le}from"./index-f858892f.js";import{r as o,G as F,u as ne,c as f,m as L,w as a,f as s,i as A,$ as re,a9 as ie,M as q,aa as ue,ab as G,a4 as Q,e as t,h as c,Z,g as j,t as P,d as I,R as B,ac as W,Q as O,ad as ce,I as J,B as X,ae as me,af as de,ag as pe,ah as fe,ai as _e,a8 as ve,W as ye}from"./index-18b660c1.js";import{f as he,b as H}from"./index-a6ad3bbb.js";import{_ as ee,P as be}from"./index-bae3b8b9.js";import{_ as ge}from"./selectProduct.vue_vue_type_script_setup_true_lang-5d10fcb1.js";import{a as te}from"./computedMaterial.vue_vue_type_script_setup_true_lang-7a0f04f7.js";import{D as ae}from"./formula-4ae4e899.js";import{_ as $e}from"./detail.vue_vue_type_script_setup_true_lang-97ae38af.js";import{L as ke}from"./index-d761e5bd.js";import"./index-c23684c8.js";import"./slotCell.vue_vue_type_script_lang-b6931333.js";import"./bom.vue_vue_type_script_setup_true_lang-95283b00.js";import"./index-0cd7f2c9.js";const Ce={__name:"edit",emits:["submit"],setup(U,{expose:N,emit:E}){const g=o(null),m=o(null),k=o(!1),K=E,D=o(null),T=F(()=>`${D.value?"编辑":"创建"}生产任务`),x=ne(),_=o([]),r=o(!1),u=e=>{e&&(r.value=!0,re({projectName:e}).then(l=>{_.value=(l.rows||[]).map(b=>({value:b.projectId,label:`${b.projectName} 【${b.projectId}】`}))}).finally(()=>{r.value=!1}))},y=o(null),h=o([{cmp:"select",name:"projectId",label:"项目编号/名称",itemOptions:{options:F(()=>_.value),filterable:!0,onSearch:u},rules:[{required:!0,message:"必选",type:"error",trigger:"change"}]},{cmp:"input",name:"productorderName",label:"生产任务名称"},{cmp:"datePicker",name:"wishDate",label:"期望完成时间",itemOptions:{valueType:"YYYY-MM-DD HH:mm:ss"}},{cmp:"desc",name:"applyName",label:"申请人"},{cmp:"textarea",name:"remark",label:"备注"},{cmp:"upload",name:"fileUrl",label:"附件",otherProps:{filenameKey:"fileName"}}]),$=async()=>{const e=await y.value.getFormData(!0);if(e===!1)return!1;const l=g.value.getProductData();if(l===!1)return!1;const b=m.value.getComputedData();if(b===!1)return!1;e.id?(await ie({...e,status:0}),q.success("生产任务编辑成功")):(await ue({...e,...b,listItem:l,status:0}),q.success("生产任务创建成功")),K("submit"),k.value=!1},p=e=>{m.value.updateData(e)};return N({open:(e=null)=>{if(D.value=e,k.value=!0,e)G({id:e}).then(l=>{const{materials:b,panel:i,accessory:n,listItem:d,...v}=l.data;g.value.setProductData(d),m.value.setComputedData({materials:b,panel:i,accessory:n}),y.value.fillFormData(l.data)});else{const l={applyId:x.info.userId,applyName:x.info.nickName};Q(()=>{y.value.fillFormData(l)})}}}),(e,l)=>{const b=ee,i=Z,n=ae;return f(),L(n,{visible:s(k),"onUpdate:visible":l[0]||(l[0]=d=>A(k)?k.value=d:null),attach:"body",header:s(T),"destroy-on-close":"",placement:"bottom",size:"100%","on-confirm":$},{body:a(()=>[t(b,{ref_key:"$form",ref:y,"label-width":"150px",forms:s(h)},null,8,["forms"]),t(i,{class:"divider",align:"left"},{default:a(()=>[c("选择生产产品")]),_:1}),t(s(ge),{ref_key:"$selectProduct",ref:g,onChange:p},null,512),t(i,{class:"divider",align:"left"},{default:a(()=>[c("计算物料用量")]),_:1}),t(s(te),{ref_key:"$computedMaterial",ref:m},null,512)]),_:1},8,["visible","header"])}}},De=Ce,xe={class:"perlist"},Pe={class:"perxh"},Ne={class:"perhd"},Le={class:"perbd"},qe={key:0,style:{"margin-right":"20px"}},Te={class:"perft"},we={__name:"optimization",emits:["submit"],setup(U,{expose:N,emit:E}){const g=o(null),m=o(!1),k=o(null),K=F(()=>`下料优化-${D.value.productorderName}`),D=o({}),T=o([]),x=o(null),_=o([{cmp:"select",name:"itemCode",label:"待优化物料",rules:[{required:!0,message:"必填",type:"error",trigger:["change"]}],itemOptions:{keys:{value:"materialCode",label:"materialName"},options:F(()=>T.value)}},{cmp:"inputNumber",name:"odd1",label:"标准去除料头长度",rules:[{required:!0,message:"必填",type:"error",trigger:["change","blur"]}],itemOptions:{min:1,step:1,decimalPlaces:0,suffix:"mm",style:"width: 250px"}},{cmp:"inputNumber",name:"odd2",label:"刀具【锯缝】宽度",rules:[{required:!0,message:"必填",type:"error",trigger:["change","blur"]}],itemOptions:{min:1,step:1,decimalPlaces:0,suffix:"mm",style:"width: 250px"}},{cmp:"inputNumber",name:"allLen",label:"物料定尺",rules:[{required:!0,message:"必填",type:"error",trigger:["change","blur"]}],itemOptions:{min:1,step:1e3,decimalPlaces:0,suffix:"mm",style:"width: 250px"}}]),r=o({}),u=o([]),y=o([]),h=()=>{u.value=[],y.value=[],r.value={odd1:20,odd2:10,allLen:6e3},Q(()=>{x.value.fillFormData({...r.value})})};let $=[],p=null,C=null;const e=async()=>{var d;const i=await x.value.getFormData(!0);if(i===!1)return!1;const n=$.filter(v=>v.materialCode==i.itemCode).map(v=>({len:v.result||0,num:v.quantity||0,extra:v.extra||0}));if(!n.length)return q.error("没有可以优化的物料，请重新选择物料");r.value.materialCode=i.itemCode,r.value.materialName=(d=$.find(v=>v.materialCode==i.itemCode))==null?void 0:d.materialName,C=ce({fullscreen:!0,attach:"body"}),p.postMessage({odd1:i.odd1,odd2:i.odd2,len:i.allLen,pers:n})},l=()=>{p.removeEventListener("message",()=>{}),p.removeEventListener("error",()=>{}),p.terminate(),C==null||C.hide()};return N({open:async(i=null)=>{k.value=i,m.value=!0,h(),i&&(G({id:i}).then(n=>{const{materials:d}=n.data;g.value.setComputedData({materials:d}),D.value=n.data,$=g.value.getComputedDataList(),T.value=$.filter((v,z)=>$.findIndex(S=>v.materialCode===S.materialCode)===z)}),p=new Worker(new URL("/smv3-pre/assets/optimization-9c417c19.js",self.location)),p.addEventListener("message",n=>{n.data.pbests&&(y.value=[n.data.odd1,n.data.odd2],u.value=[n.data.pbests]),q.success("计算完成"),C.hide()}),p.addEventListener("error",n=>{q.error("计算失败"),C.hide()}))}}),(i,n)=>{const d=Z,v=ee,z=J,S=X,V=me,se=ae;return f(),L(se,{visible:s(m),"onUpdate:visible":n[1]||(n[1]=M=>A(m)?m.value=M:null),attach:"body",header:s(K),"destroy-on-close":"",placement:"bottom",size:"100%",footer:!1,closeBtn:!0,onClose:l},{body:a(()=>[t(d,{class:"divider",align:"left"},{default:a(()=>[c("物料用量")]),_:1}),t(s(te),{ref_key:"$computedMaterial",ref:g,isDetail:!0,displayTabs:["materials"]},null,512),t(d,{class:"divider",align:"left"},{default:a(()=>[c("设置优化选项")]),_:1}),t(v,{ref_key:"$form",ref:x,"label-width":"180px",forms:s(_)},null,8,["forms"]),j("p",null,[t(S,{variant:"outline",theme:"default",onClick:n[0]||(n[0]=M=>e())},{icon:a(()=>[t(z,{name:"calculator-1"})]),default:a(()=>[c(" 计算下料优化 ")]),_:1})]),t(d,{class:"divider",align:"left"},{default:a(()=>[c("优化结果")]),_:1}),s(u).length>0?(f(),L(V,{key:0},{default:a(()=>{var M,Y;return[t(d,{class:"divider",align:"left"},{default:a(()=>[c("标准去除料头长度"+P(s(y)[0]||0)+"毫米，刀具（锯缝）宽度"+P(s(y)[1]||0)+"毫米",1)]),_:1}),t(V,{title:`${s(r).materialName}【${s(r).materialCode}】`,actions:`定尺：${s(r).allLen}毫米，数量：${(M=s(u)[0])==null?void 0:M.nums}支，利用率：${(Y=s(u)[0])==null?void 0:Y.utilization}%`},{default:a(()=>[t(d),(f(!0),I(B,null,W(s(u)[0].pbests,(R,oe)=>(f(),I("div",xe,[j("div",Pe,P(oe+1)+"）",1),j("div",Ne,P(R.nums)+"支：",1),j("div",Le,[(f(!0),I(B,null,W(R.pers,(w,Ie)=>(f(),I(B,null,[w.num>0?(f(),I("span",qe,P(w.len)+P(w.extra?`(${w.extra>0?"+":""}${w.extra})`:"")+P("x"+w.num)+"；",1)):O("",!0)],64))),256))]),j("div",Te,"料头："+P(R.odd)+"毫米",1)]))),256))]),_:1},8,["title","actions"])]}),_:1})):O("",!0)]),_:1},8,["visible","header"])}}},We={__name:"index",setup(U){const N=o(null),E=o(null),g=o(null),m=o(null),k=[{cmp:"input",name:"productorderName",label:"生产任务名称"},{cmp:"select",name:"status",label:"状态",itemOptions:{options:he(H)}}],K=[{colKey:"serial-number",title:"#",width:60},{colKey:"id",title:"生产任务编号"},{colKey:"productorderName",title:"生产任务名称"},{colKey:"createTime",title:"申请时间"},{colKey:"designer",title:"设计师"},{colKey:"wishDate",title:"期望完成时间"},{colKey:"status",title:"状态",cell:(_,{row:r})=>{var u;return(u=H[r.status])==null?void 0:u.label}},{colKey:"remark",title:"备注"},{colKey:"processName",title:"审核人"},{colKey:"processTime",title:"通过时间"},{colKey:"operation",title:"操作",width:180}],D=_=>{pe({id:_,status:1}).then(()=>{q.success("生产任务已提交审核"),m.value.refresh()})},T=_=>{fe({id:_}).then(()=>{q.success("生产任务删除成功"),m.value.refresh()})},x=async(_,r)=>{const u=await _e({id:_});ve(u,r)};return(_,r)=>{const u=J,y=X,h=ke,$=ye,p=be,C=le;return f(),I(B,null,[t(C,{ref_key:"$table",ref:m,searchItems:k,columns:K,api:s(de)},{topBtns:a(()=>[t(y,{onClick:r[0]||(r[0]=e=>s(N).open())},{icon:a(()=>[t(u,{name:"add"})]),default:a(()=>[c(" 新建生产任务 ")]),_:1})]),operation:a(({row:e})=>[t($,null,{default:a(()=>[t(h,{theme:"primary",onClick:l=>s(E).open(e.id)},{default:a(()=>[c(" 查看 ")]),_:2},1032,["onClick"]),t(h,{theme:"primary",onClick:l=>x(e.id,e.productorderName)},{default:a(()=>[c(" 导出 ")]),_:2},1032,["onClick"]),t(h,{theme:"primary",onClick:l=>s(g).open(e.id)},{default:a(()=>[c(" 下料优化")]),_:2},1032,["onClick"])]),_:2},1024),t($,null,{default:a(()=>[e.status==0||e.status==9?(f(),L(h,{key:0,theme:"primary",onClick:l=>s(N).open(e.id)},{default:a(()=>[c(" 编辑")]),_:2},1032,["onClick"])):O("",!0),e.status==0||e.status==9?(f(),L(p,{key:1,content:"确认删除此生产任务吗？",onConfirm:l=>T(e.id)},{default:a(()=>[t(h,{theme:"primary"},{default:a(()=>[c(" 删除 ")]),_:1})]),_:2},1032,["onConfirm"])):O("",!0),e.status==0?(f(),L(p,{key:2,content:"确认提交审核此生产任务吗？",onConfirm:l=>D(e.id)},{default:a(()=>[t(h,{theme:"primary"},{default:a(()=>[c(" 提交审核 ")]),_:1})]),_:2},1032,["onConfirm"])):O("",!0),e.status==9?(f(),L(p,{key:3,content:"确认提交审核此生产任务吗？",onConfirm:l=>D(e.id)},{default:a(()=>[t(h,{theme:"primary"},{default:a(()=>[c(" 重新提交 ")]),_:1})]),_:2},1032,["onConfirm"])):O("",!0)]),_:2},1024)]),_:1},8,["api"]),t(De,{ref_key:"$DialogEdit",ref:N,onSubmit:r[1]||(r[1]=e=>s(m).refresh())},null,512),t($e,{ref_key:"$DialogDetail",ref:E},null,512),t(we,{ref_key:"$DialogOptimization",ref:g},null,512)],64)}}};export{We as default};
